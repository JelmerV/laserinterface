#:kivy 1.11.0

<FileSelector>:     # Based on BoxLayout
    orientation: "horizontal"
    spacing: 10
    padding: 10

    selected_file: "Please select a file"

    ShadedBoxLayout:
        PlottedGcode:
            size_hint: (1, 1)
            id: plotted_preview

    ShadedBoxLayout:
        size_hint_x: 0.4
        orientation: 'vertical'
        spacing: 10
        padding: 10

        # Show the contents of the gcode file
        RecycleView:
            size_hint_y: 0.4
            id: gcode_preview
            viewclass: 'GcodeLine'
            RecycleBoxLayout:
                size_hint: 1, None
                height: self.minimum_height
                orientation: 'vertical'

                default_size: None, dp(30)
                default_size_hint: 1, None

        # list of files to choose from
        FileChooserListView:
            size_hint_y: 0.5
            id: filechooser
            path: '/home/pi/gcode_files'
            on_selection:
                root.on_file_selected(self.selection[0])

        Label:
            size_hint_y: 0.1
            text: 'Estimated duration: {:.0f}min, {:.0f}sec.'.format(plotted_preview.job_duration, (plotted_preview.job_duration*60)%60)

        BoxLayout:
            size_hint_y: 0.1
            orientation: "horizontal"

            # show name of selected file:
            Label:
                size_hint_x: 0.7
                text_size: self.size
                halign: 'left'
                valign: 'middle'
                text: root.selected_file

            # button to continue after selecting the correct file
            Button:
                size_hint_x: 0.3
                text: 'continue'
                on_press:
                    print(root.selected_file)
                    app.root.ids.home.ids.job_control.selected_file = root.selected_file
                    app.root.ids.sm.current = 'home'

<PlottedGcode>:  # basic widget used for the drawing canvas
    # size: 200, 1000
    job_duration: 0

    canvas.before:
        Color:
            # rgba: 0.85, 0.345, 0.456, 0.5
            rgba: 0.494, 0.337, 0.125, 0
        Rectangle:
            size: self.size
            pos: self.pos
    Label:
        id: plottedgcode_label
        pos_hint: {'center_y': 0.5, 'center_x': 0.5}
        size_hint: 0.3, 0.3
        font_size: '30sp'

    Label:
        id: max_x_label
        size_hint: None, None
        size: 75, 20
        pos: 0, 3
        text: '{:.2f}mm'.format(root.max_x)

    Label:
        id: max_y_label
        size_hint: None, None
        size: 75, 20
        pos: 0, 3
        text: '{:.2f}mm'.format(root.max_y)

    GridLayout:
        pos_hint: {'right': 0.98, 'top': 0.98}
        size_hint: 0.2, 0.1
        id: caption

        cols: 2

        Label:
            text: 'Rapid move:'
        Widget:
            canvas.after:
                Color:
                    rgb: (0.8, 0.415, 0.886)
                Line:
                    width: 2
                    group: 'caption'
                    points: (self.center_x-self.width/3, self.center_y, self.center_x+self.width/3, self.center_y)

        Label:
            text: 'Linear move:'
        Widget:
            canvas.after:
                Color:
                    rgb: (0.415, 0.886, 0.717)
                Line:
                    width: 2
                    group: 'caption'
                    points: (self.center_x-self.width/3, self.center_y, self.center_x+self.width/3, self.center_y)

        Label:
            text: 'Arc move:'
        Widget:
            canvas.after:
                Color:
                    rgb: (0.415, 0.623, 0.886)
                Line:
                    width: 2
                    group: 'caption'
                    points: (self.center_x-self.width/3, self.center_y, self.center_x+self.width/3, self.center_y)

<GcodeLine@BoxLayout>:
    orientation: 'horizontal'
    spacing: 1

    gcode: '???'
    line_nr: 999

    canvas:
        Color:
            rgb: (0.2, 0.2, 0.2)
        Rectangle:
            pos: self.pos
            size: self.size

    Label:
        size_hint: 0.1, 1
        padding: (10, 0)
        text: str(root.line_nr)
    Label:
        # canvas.before:
        #     Color:
        #         rgba: (0.2, 0.2, 0.2, 1)
        #     Rectangle:
        #         size: self.size
        #         pos: self.pos
        size_hint: 0.9, 1
        padding: (10, 0)
        text_size: self.width, None
        height: self.texture_size[1]
        text: str(root.gcode)
